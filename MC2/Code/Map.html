<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>Basic geo (svg)</title>
</head>

<style>
    #content .map path {
        fill: #ddd;
        stroke: #aaa;
    }

    #content .map circle:hover {
        fill: black;
    }

    #tooltip {
        position: absolute;
        text-align: center;
        padding: 20px;
        margin: 10px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 1px;
        border-radius: 2px;
        pointer-events: none;
    }

    #tooltip h4 {
        margin: 0;
        font-size: 14px;
    }

    #tooltip {
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid grey;
        border-radius: 5px;
        font-size: 12px;
        width: auto;
        padding: 4px;
        color: white;
        opacity: 0;
    }

</style>

<body>
    <div id="tooltip"></div>
    <div id="content">
        <svg width="400px" height="400px">
            <g class="map"></g>
        </svg>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>


    <script>
        d3.json('StHimark.geojson', geojson => {

            let width = 400,
                height = 400;
            let projection = d3.geoEquirectangular().scale(1).translate([0, 0]);

            let geoGenerator = d3.geoPath()
                .projection(projection);

            //Scaling and translating.
            var b = geoGenerator.bounds(geojson),
                s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
                t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

            projection.scale(s).translate(t);

            function update(geojson) {
                var u = d3.select('#content g.map')
                    .selectAll('path')
                    .data(geojson.features);

                //creates the map
                u.enter()
                    .append('path')
                    .attr('d', geoGenerator);


                //adds labels to the towns
                u.enter()
                    .append("svg:text")
                    .text(function(d) {
                        return d.properties.Nbrhood;
                    })
                    .attr("x", function(d) {
                        //console.log(d);
                        return geoGenerator.centroid(d)[0];
                    })
                    .attr("y", function(d) {
                        return geoGenerator.centroid(d)[1];
                    })
                    .attr("text-anchor", "middle")
                    .attr('font-size', '6pt');



                //adds the Nuclear Power Plant to the map
                var aa = [0.162679, -119.784825];
                u.enter().data(aa)
                    .append('circle')
                    .attr("cx", function(d) {
                        return projection([aa[1], aa[0]])[0];
                    })
                    .attr("cy", function(d) {
                        return projection([aa[1], aa[0]])[1];
                    })
                    .attr("r", "8px")
                    .attr("fill", "yellow")
                    .attr('id', "PowerPlant")
                    .attr("stroke", "black")
                    .on("mouseover", mouseOver).on("mouseout", mouseOut);
                var StaticLocations


                //loads the static sensor locations 
                d3.csv("../data/StaticSensorLocations.csv", function(data) {
                    StaticLocations = data;
                    //console.log(data);



                    u.enter().data(data)
                        .append('circle')
                        .attr("cx", function(d) {
                            return projection([d.Long, d.Lat])[0];
                        })
                        .attr("cy", function(d) {
                            return projection([d.Long, d.Lat])[1];
                        })
                        .attr("r", "5px")
                        .attr("fill", "red")
                        .attr('id', function(d) {
                            return d.Sensor;
                        }).on("mouseover", mouseOver).on("mouseout", mouseOut);
                    console.log("finished");
                });

                function mouseOver(d) {
                    d3.select("#tooltip").transition().duration(200).style("opacity", .9);
                    var x = d.Sensor
                    if (typeof x  != "undefined" && typeof d.Value == "undefined") {
                        d3.select("#tooltip").html(toolTip(d.Sensor, "Static Sensor #"))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }
                    else{
                        d3.select("#tooltip").html(toolTip("", "Power Plant"))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }
                    //console.log(d);
                }

                function toolTip(n, d) {
                    //console.log(n);
                    return "<h4>" + d + " " + n + "</h4>";
                }


                function mouseOut() {
                    d3.select("#tooltip").transition().duration(500).style("opacity", 0);
                }
            }

            update(geojson);
        });

    </script>
</body>
