<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>Basic geo (svg)</title>
</head>

<style>
    #content .map path {
        fill: #ddd;
        stroke: #aaa;
    }

    #content .map circle:hover {
        fill: black;
    }
    
    #tooltip {
        position: absolute;
        text-align: center;
        padding: 20px;
        margin: 10px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 1px;
        border-radius: 2px;
        pointer-events: none;
    }

    #tooltip h4 {
        margin: 0;
        font-size: 14px;
    }

    #tooltip {
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid grey;
        border-radius: 5px;
        font-size: 12px;
        width: auto;
        padding: 4px;
        color: white;
        opacity: 0;
    }

</style>

<body>
    <div id="tooltip"></div>
    <div id="content">
        <svg width="400px" height="400px">
            <g class="map"></g>
        </svg>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>


    <script>
        d3.json('StHimark.geojson', geojson => {

            let width = 400,
                height = 400;
            let projection = d3.geoEquirectangular().scale(1).translate([0, 0]);

            let geoGenerator = d3.geoPath()
                .projection(projection);

            //Scaling and translating.
            var b = geoGenerator.bounds(geojson),
                s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
                t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

            projection.scale(s).translate(t);

            function update(geojson) {
                var u = d3.select('#content g.map')
                    .selectAll('path')
                    .data(geojson.features);

                //creates the map
                u.enter()
                    .append('path')
                    .attr('d', geoGenerator);


                //adds labels to the towns
                u.enter()
                    .append("svg:text")
                    .text(function(d) {
                        return d.properties.Nbrhood;
                    })
                    .attr("x", function(d) {
                        //console.log(d);
                        return geoGenerator.centroid(d)[0];
                    })
                    .attr("y", function(d) {
                        return geoGenerator.centroid(d)[1];
                    })
                    .attr("text-anchor", "middle")
                    .attr('font-size', '6pt');



                //adds the Nuclear Power Plant to the map
                var aa = [0.162679, -119.784825];
                u.enter().data(aa)
                    .append('circle')
                    .attr("cx", function(d) {
                        return projection([aa[1], aa[0]])[0];
                    })
                    .attr("cy", function(d) {
                        return projection([aa[1], aa[0]])[1];
                    })
                    .attr("r", "8px")
                    .attr("fill", "yellow")
                    .attr('id', "Hospital")
                    .attr("stroke", "black");
                var StaticLocations


                //loads the static sensor locations 
                d3.csv("../data/StaticSensorLocations.csv", function(data) {
                    StaticLocations = data;
                    //console.log(data);

                    function mouseOver(d) {
                        d3.select("#tooltip").transition().duration(200).style("opacity", .9);

                        d3.select("#tooltip").html(toolTip(d.Sensor))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                        console.log(d);
                    }

                    function toolTip(n) {
                        console.log(n);
                        return "<h4>" + n + "</h4>";
                    }


                    function mouseOut() {
                        d3.select("#tooltip").transition().duration(500).style("opacity", 0);
                    }

                    u.enter().data(data)
                        .append('circle')
                        .attr("cx", function(d) {
                            return projection([d.Long, d.Lat])[0];
                        })
                        .attr("cy", function(d) {
                            return projection([d.Long, d.Lat])[1];
                        })
                        .attr("r", "5px")
                        .attr("fill", "red")
                        .attr('id', function(d) {
                            return d.Sensor;
                        }).on("mouseover", mouseOver).on("mouseout",mouseOut);
                    console.log("finished");
                });



            }

            update(geojson);
        });

    </script>

    <P>Select date: </P>
    <p> 4/  <select id="dateSelection">
        <option value="6" selected="selected">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
    </select> /20    <select id="hourSelection">
        <option value="0" selected="selected">00</option>
        <option value="1">01</option>
        <option value="2">02</option>
        <option value="3">03</option>
        <option value="4">04</option>
        <option value="5">05</option>
        <option value="6">06</option>
        <option value="7">07</option>
        <option value="8">08</option>
        <option value="9">09</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
    </select> : <select id="minuteSelection">
        <option value="00" selected="selected">00</option>
        <option value="01">01</option>
        <option value="02">02</option>
        <option value="03">03</option>
        <option value="04">04</option>
        <option value="05">05</option>
        <option value="06">06</option>
        <option value="07">07</option>
        <option value="08">08</option>
        <option value="09">09</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        <option value="27">27</option>
        <option value="28">28</option>
        <option value="29">29</option>
        <option value="30">30</option>
        <option value="31">31</option>
        <option value="32">32</option>
        <option value="33">33</option>
        <option value="34">34</option>
        <option value="35">35</option>
        <option value="36">36</option>
        <option value="37">37</option>
        <option value="38">38</option>
        <option value="39">39</option>
        <option value="40">40</option>
        <option value="41">41</option>
        <option value="42">42</option>
        <option value="43">43</option>
        <option value="44">44</option>
        <option value="45">45</option>
        <option value="46">46</option>
        <option value="47">47</option>
        <option value="48">48</option>
        <option value="49">49</option>
        <option value="50">50</option>
        <option value="51">51</option>
        <option value="52">52</option>
        <option value="53">53</option>
        <option value="54">54</option>
        <option value="55">55</option>
        <option value="56">56</option>
        <option value="57">57</option>
        <option value="58">58</option>
        <option value="59">59</option>
    </select> <button onclick="updateData()">Update</button></p>
    <svg id="barGraph" width="600" height="400" />
    <svg id="lineGraph" width="600" height="400" />

</body>


<!---------Bar chart ------------->
<script>

    //--- create graph ----------------------//
    const margin = 60;
    const width = 600 - 2 * margin;
    const height = 400 - 2 * margin;

    const svg = d3.select("#barGraph");

    const chart = svg.append('g')
        .attr('transform', `translate(${margin}, ${margin})`)
        .attr('id','#barChart');

    const yScale = d3.scaleLinear()
        .range([height, 0])

    const xScale = d3.scaleBand()
        .range([0, width])
        .padding(0.2)

    //--- add titles ---------//
    chart.append('text')
        .attr('x', -height/2)
        .attr('y', -margin/2)
        .attr('transform', 'rotate(-90)')
        .attr('text-anchor', 'middle')
        .text('Reading (cpm)')

    chart.append('text')
        .attr('x', width / 2 )
        .attr('y', -15)
        .attr('text-anchor', 'middle')
        .text('Sensor Readings at Selected Time')

    //--- set up base data -----//
    const sensorIDs = [1,4,6,9,11,12,13,14,15];


    //--- import data ----------------------//
    var allFiltData = [];

    console.log("start!");

    d3.csv("../data/StaticSensorReadingsREDOWNLOAD.csv", function (data) {

        //--- set up time selected ----
        var day = document.getElementById("dateSelection").value;
        var hour = document.getElementById("hourSelection").value;
        var minute = document.getElementById("minuteSelection").value;

        var selectedTimeStamp = "4/" + day + "/20 " + hour + ":" + minute;
        console.log("selectionTimeStamp: " + selectedTimeStamp);

        //-- sort data by sensor id ----
        for (var i = 0; i < sensorIDs.length; i++) {

            //-- filter for time and sensorid
            var filteredData = data.filter(function (d) {
                if (d["Sensorid"] == sensorIDs[i] && d["Timestamp"] == selectedTimeStamp) {
                    return d;
                }
            })
            //-- get average
            var valueAvg = d3.mean(filteredData, function (d) {
                return d.Value;
            });

            //-- add to allFiltData
            var temp = {
                "Sensorid": sensorIDs[i],
                "Value": valueAvg
            }

            allFiltData.push(temp);

        }
        console.log("finished data")
        buildInital();
    });

    //--- build initial axises ----------//
    function buildInital() {
        console.log("running initial");
        //-- add axises -----
        var maxY = d3.max(allFiltData, function (d) {
            return d.Value
        });

        console.log("maxY: " + maxY);

        yScale.domain([0, maxY+5]);

        chart.append('g')
            .call(d3.axisLeft(yScale));

        xScale.domain(allFiltData.map((s) => s.Sensorid));

        chart.append('g')
            .attr('transform', `translate(0, ${height})`)
            .call(d3.axisBottom(xScale));

        //-- show rectangles (values) ---
        chart.selectAll()
            .data(allFiltData)
            .enter()
            .append('rect')
            .attr('class', 'bar')
            .attr('x', (s) => xScale(s.Sensorid))
            .attr('y', (s) => yScale(s.Value))
            .attr('height', (s) => height - yScale(s.Value))
            .attr('width', xScale.bandwidth())

        var bars = svg.selectAll(".bar");
        bars
            .on('mouseenter', function (actual, i) {
                d3.select(this).attr('opacity', 0.5)
            })
            .on('mouseleave', function (actual, i) {
                d3.select(this).attr('opacity', 1)
            })

    }


    //------ update ---------------//

    function updateData() {

        //--- import data ----------------------//
        allFiltData = [];

        //--- get data ----------
        d3.csv("../data/StaticSensorReadingsREDOWNLOAD.csv", function (data) {

            //--- set up time selected ----
            var day = document.getElementById("dateSelection").value;
            var hour = document.getElementById("hourSelection").value;
            var minute = document.getElementById("minuteSelection").value;

            var selectedTimeStamp = "4/" + day + "/20 " + hour + ":" + minute;
            console.log("selectionTimeStamp: " + selectedTimeStamp);

            //-- sort data by sensor id ----
            for (var i = 0; i < sensorIDs.length; i++) {

                //-- filter for time and sensorid
                var filteredData = data.filter(function (d) {
                    if (d["Sensorid"] == sensorIDs[i] && d["Timestamp"] == selectedTimeStamp) {
                        return d;
                    }
                })
                //-- get average
                var valueAvg = d3.mean(filteredData, function (d) {
                    return d.Value;
                });

                if(valueAvg == undefined){
                    valueAvg = 0;
                }

                //-- add to allFiltData
                var temp = {
                    "Sensorid": sensorIDs[i],
                    "Value": valueAvg
                }

                allFiltData.push(temp);

            }
            console.log("finished data");
            updateGraph();
        });
    }

    function updateGraph() {
        console.log("start update");
        var maxY = d3.max(allFiltData, function (d) {
            return d.Value
        });

        console.log("maxY: "+maxY);
        var duration = 300;


        xScale.domain(allFiltData.map((s) => s.Sensorid));
        yScale.domain([0, maxY+5]);

        console.log(allFiltData);

        var bars = svg.selectAll(".bar")
            .data(allFiltData);

        bars
            .enter()
            .append('rect')
            .attr('class', 'bar')
            .attr("fill", "red")
            .attr('width', xScale.bandwidth())
            .attr('height', 0)
            .attr('y', height)
            .merge(bars)
            .transition()
            .duration(duration)
            .attr('x', (s) => xScale(s.Sensorid))
            .attr('y', (s) => yScale(s.Value))
            .attr('height', (s) => height - yScale(s.Value))
            .attr('width', xScale.bandwidth())


        bars
            .exit()
            .transition()
            .duration(duration)
            .attr('height', 0)
            .attr('y', height)
            .remove();

        bars
            .on('mouseenter', function (actual, i) {
                d3.select(this).attr('opacity', 0.5)
            })
            .on('mouseleave', function (actual, i) {
                d3.select(this).attr('opacity', 1)
            })

        var xaxis = d3.axisBottom(xScale);

        var yaxis = d3.axisLeft(yScale);


        svg.select('.x.axis')
            .transition()
            .duration(duration)
            .call(xaxis);

        svg.select('.y.axis')
            .transition()
            .duration(duration)
            .call(yaxis);
    }

</script>

<!---------Static Line Chart------------->
<script>

    const svgLine = d3.select("#lineGraph");

    //--- set ranges ---
    var x = d3.scaleTime().range([0, width]);
    var y = d3.scaleLinear().range([height, 0]);

    //--- build graph ---
    svgLine.append("g")
        .attr("transform",
            "translate(" + margin + "," + margin + ")");

    //--- set base data -----
    //** sensorIDs order : [1,4,6,9,11,12,13,14,15] **
    const sensorColors = ["Red","Orange","Gold","Green","LimeGreen","Blue", "DarkBlue", "Purple", "DeepPink"];

    var parseTime = d3.timeParse("%m-%-d-%y %H:%M");

    //--- import data ----------------------//
    allFiltData = [];

    //--- get data ----------
    d3.csv("../data/StaticSensorReadingsREDOWNLOAD.csv", function (data) {

        //-- sort data by sensor id ----
        for (var i = 0; i < sensorIDs.length; i++) {
            var currentSensorData =[];
            for(var day=6; day<=10; day++) {
                for(var hour=0; hour<=23; hour++){
                    for(var min=0; min<=59; min++) {

                        //-- filter for time and sensorid

                        var loopTime = "4/"+day+"/20 "+hour+":"+min;

                        var filteredData = data.filter(function (d) {
                            if ( d["Sensorid"] == sensorIDs[i] && d["Timestamp"] == loopTime) {
                                return d;
                            }
                        })
                        //-- get average
                        var valueAvg = d3.mean(filteredData, function (d) {
                            return d.Value;
                        });

                        if (valueAvg == undefined) {
                            valueAvg = 0;
                        }

                        //-- add to allFiltData
                        var temp = {
                            "time": parseTime(loopTime),
                            "value": valueAvg
                        }
                        console.log("---time for "+sensorIDs[i]+": "+loopTime)
                        console.log("parseTime: "+parseTime(loopTime))

                        currentSensorData.push(temp);

                    }
                }
            }

            //--- define the line for sensor i ----
            var valueLine = d3.line()
                .x(function(d) { return x(d.time); })
                .y(function(d) { return y(d.value); });

            //--- add path ----
            svgLine.append("path")
                .data([data])
                .attr("class", "line")
                .attr("d", valueLine)
                .style("stroke", sensorColors[i])
                .attr("id","path"+sensorIDs[i]);


            console.log("finished data for: "+sensorIDs[i]);

        }

    });

    //--- Scale the range of the data ----
    x.domain([parseTime("4/6/20 00:00", "4/10/20 23:59")]);
    y.domain([0, 25]);

    // Add the X Axis
    svgLine.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    // Add the Y Axis
    svgLine.append("g")
        .call(d3.axisLeft(y));



</script>